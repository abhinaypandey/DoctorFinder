<!doctype html>
<html>
<head>
    <title>Doc Finder</title>
    
  <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  <script src="/TestApp/webroot/scripts/bootstrap.min.js"></script>
    <link rel="stylesheet" href="/TestApp/webroot/css/bootstrap.min.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
      <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-YyzS_SXIeh4QAhGtW2o4UCe4NWvSXnw&signed_in=true&libraries=places" async defer></script>
    
<style>

html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  #map {
    display:none;
    height: 80%;
    top:20%;
  }

  #zip-select >li:hover{
    background-color:blue;
    color:white;
  }

  #docs-div{
    margin-top:3%;
  }

      
</style>
</head>
<body>
<div style="padding:10px;">

      <div class="well">
        <form name="docFinderForm">
            <div style="width:90%;position:relative;display:inline;">
              <div style="width:20%;float:left;"> 
                  <input id="zip" type="text" name="zipcode" placeholder="zipcode" value=""/>
                  <span id="zip-drop" style="display:none;overflow-y:scroll;z-index: 1;position: absolute;width: 215px;height:100px;background-color: #FFF;top:30px;left: 2px;border: 1px solid #808080;">
                        <ul id="zip-select" style="list-style:none;top:5px">
                        </ul>
                  </span>
              </div>
              <div style="width:60%;float:left;">
                 <input id="radius" name="radius" type="text" value="" placeholder="radius(in meters)" style="width:20%;float:left;margin-right:3%;"/>
                 <div id="radius-slider" style="width:40%;float:left;margin-right:3%;"></div>
              </div>
              
            </div>
            <button id="queryBtn" type="button" class="btn btn-primary">Query</button> 
      </form>
      </div>
      
      
      <div id="map"></div>
      <div id="docs-div" class="well">
      </div>
</div>

<script type="text/javascript">
var zip;
var rad;
$(document).ready(function(){
           
            $("#queryBtn").on('click',function(){
               zip=$('#zip').val();
               rad=$('#radius').val();
               
              if(zip.length!=0 && rad.length!=0){
                initMap(zip,rad);
              }
              else{
                alert('enter both fields');
              }
                        
            });
            
            $('#zip').on('keyup',function(){
                  $('#zip-select').html('');
                  zip=$.trim($('#zip').val());
                  
                  if(zip.length>=2){
                        $.ajax({
                              url:'query.lasso',
                              dataType:'json',
                              type:'post',
                              data:{zipkey:zip},
                              success:function(data){

                                    $.each(data.data,function(k,v){
                                      if(v.length!=0){
                                         $('<li style="cursor:pointer;border-bottom:whitesmoke solid 1px;" onclick="selectZip('+v.id+');">'+v.id+'</li>').appendTo("#zip-select");
                                        
                                      }
                                    });
                                         
                                    var c=$('#zip-select li').length;
                        
                                    if(c>0 ){
                                      $('#zip-drop').show();
                                    }
                              }
                        });
                  }
                  else{
                        $('#zip-drop').hide();
                  }
            });
            
            $('#radius-slider').slider({
              range:'min',
              min:0,
              max:50000,
              slide: function(event,ui){
                $('#radius').val(ui.value);
                rad=$('#radius').val();
              }
              
            });
            
            $('#radius').on('click',function(){
              $('#zip-drop').hide();
            }); 
            
      
});

function selectZip(zip){
  $('#zip').val(zip);
  zip=$('#zip').val();
  $('#zip-drop').hide();
}
</script>

<script>

var map;
var resultsarray= new Array();


function initMap(zip,rad) {
  $('#docs-div').html('');
  var zip=zip
  var pyrmont;
    var rad=rad;
    var geocoder = new google.maps.Geocoder();
 
  
  if(zip.length!=0){
 
    geocoder.geocode( { 'address': zip}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        pyrmont=results[0].geometry.location;
        console.log('p'+pyrmont);
        
         map = new google.maps.Map(document.getElementById('map'), {
        center: pyrmont,
        zoom: 15
      });
    
      var service = new google.maps.places.PlacesService(map);
      console.log('pp'+pyrmont);
      service.nearbySearch({
        location: pyrmont,
        radius: rad,
        types: ['doctor','hospital','pharmacy','health','physicians','dentist'],
      }, 
      function processResults(results, status, pagination) {
      console.log('pr called');
        if (status !== google.maps.places.PlacesServiceStatus.OK) {
          console.log(status);
          return;
        } else { 
          for(var i=0;i<results.length;i++){
            service.getDetails({
                placeId: results[i].place_id
              },
              function(place,status){
                console.log(place);
                if(status === google.maps.places.PlacesServiceStatus.OK){
                  $('<div class="well"><a><h4>'+place.name+'</h4></a>'+
                '<p>'+place.formatted_address+'</p>'+
                '<a target="_blank" href="viewdoctor.html?addrs='+place.name+" "+place.formatted_address+'">'+'View on map'+'</a></div>').appendTo('#docs-div');
                }
              });
          }
            if (pagination.hasNextPage) {
               pagination.nextPage();  
            }
        }      
    });
    
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  }  
}


function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

   </script>

</body>
</html>
